name: Cypress Tests

on:
  push:

jobs:
  cypress-run:
    runs-on: ubuntu-24.04
    services:
      mysql:
        image: mysql:9
        ports:
          - "3306:3306"
        env:
          MYSQL_ROOT_PASSWORD: test
        options: >
          --health-cmd "mysqladmin ping -ptest"
          --health-interval 10s
          --health-start-period 10s
          --health-timeout 5s
          --health-retries 10
      mqtt:
        image: eclipse-mosquitto:latest
        ports:
          - "1883:1883"
          - "9001:9001"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Migrate
        run: mysql -u"root" -p"test" -h"127.0.0.1" --port=3306 < ./run/db-migration.sql

      - name: MQTT Setup
        run: |
          sleep 10
          docker exec ${{job.services.mqtt.id}} sh -c "echo listener 1883 > /mosquitto/config/mosquitto.conf"
          docker exec ${{job.services.mqtt.id}} sh -c "echo allow_anonymous true >> /mosquitto/config/mosquitto.conf"
          docker restart ${{job.services.mqtt.id}}

      - name: MQTT Healthcheck
        run: |
          sleep 10
          docker ps
          nc -zv 127.0.0.1 1883
          sudo apt-get update && sudo apt-get install -y mosquitto-clients
          mosquitto_pub -h 127.0.0.1 -p 1883 -t "test" -m "healthcheck" || exit 1

      - name: Set up JDK 23
        uses: actions/setup-java@v4
        with:
          java-version: '23'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run with Gradle Wrapper
        run: ./gradlew :api:run

      - name: Cypress Run
        uses: cypress-io/github-action@v6
        with:
          build: npm run build
          start: npm start
          browser: firefox
